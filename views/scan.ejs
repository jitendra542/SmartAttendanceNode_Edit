<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Scan - Smart Attendance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">
  <h3>Scan QR (Webcam)</h3>
  <div class="row g-3">
    <div class="col-md-6">
      <div id="reader" style="width:100%;max-width:480px"></div>
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <h5>Result</h5>
        <p id="status">Waiting...</p>
        <div class="mb-2">
          <label class="form-label">Course (optional)</label>
          <input id="course" class="form-control" placeholder="e.g. CS101">
        </div>
        <a class="btn btn-secondary" href="/students">Back</a>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>
    const statusEl = document.getElementById('status');
    const courseEl = document.getElementById('course');
    const html5QrcodeScanner = new Html5Qrcode("reader");

    function onScanSuccess(decodedText, decodedResult) {
      statusEl.textContent = 'Scanned: ' + decodedText + ' â€” marking...';
      fetch('/api/mark', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roll: decodedText.trim() })
      }).then(r => r.json()).then(data => {
        if (data.ok) {
          statusEl.textContent = `Marked: ${data.student.name} (${data.student.roll}) @ ${data.timestamp}`;
        } else {
          statusEl.textContent = 'Error: ' + data.error;
        }
      }).catch(err => statusEl.textContent = 'Error: ' + err);
    }

    function onScanFailure(error) {}

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrcodeScanner.start(devices[0].id, { fps: 10, qrbox: 250 }, onScanSuccess, onScanFailure);
      } else {
        statusEl.textContent = 'No camera found.';
      }
    }).catch(err => statusEl.textContent = 'Camera error: ' + err);
  </script>
</body>
</html>